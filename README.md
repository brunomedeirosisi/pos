# POS Starter (Web + API + Agent) – DBF Migration Ready

A minimal, production-lean starter for a **POS Web** with:
- **Backend**: Node.js + Express + TypeScript + `pg` (PostgreSQL)
- **Frontend**: React + TypeScript + Vite (PWA-ready)
- **Agent Local**: Node service exposing `POST /print` on `127.0.0.1:9222` (stub)
- **Infra**: Docker Compose (Caddy reverse proxy with internal TLS, API, Postgres, Redis)

## Quickstart

```bash
# 1) copy .env.example to .env and adjust secrets
cp .env.example .env

# 2) docker compose up (first build takes a bit)
docker compose up --build
```

Then open: `https://pos.localhost/`

> The initial certs are generated by **Caddy** with **internal TLS**. Your browser may require trusting the local CA on first run.

### Services

- **reverse-proxy**: Caddy at `https://pos.localhost`
- **api**: Node/Express at `http://api:8080` (proxied by Caddy)
- **frontend**: Vite preview server at `http://frontend:5173` (proxied by Caddy)
- **db**: PostgreSQL 16 with initial schema (`sql/init.sql`)
- **redis**: Redis 7 (for future queues/sessions – optional)
- **agent**: local peripherals stub (runs on host or separate machine; not in compose by default).

### Endpoints

- `GET /api/v1/health` – health check
- `GET /api/v1/products` – list products
- `POST /api/v1/products` – create product
- `GET /api/v1/products/:id` – get product
- `PATCH /api/v1/products/:id` – update product

### PWA & Offline

This starter registers a basic service worker and includes a `manifest.webmanifest`. Extend `src/sw.ts` and caching strategy.

### Migration (DBF → Staging → Core)

- Place your **staging CSVs** in `backend/sql/staging/` and craft `backend/sql/migrate_staging.sql`.
- Use `backend/scripts/etl.ts` as the starting point for pipeline steps (CSV→staging→core).

---

## Scripts

```bash
# backend
cd backend
npm i
npm run dev          # local dev outside docker
npm run db:init      # apply init.sql to local DB (requires POSTGRES_* envs)

# frontend
cd frontend
npm i
npm run dev
```

---

## Notes

- This is a **starter**. You will add authentication (JWT/refresh), RBAC, more entities, tests, and robust printing/TEF integrations.
- For local printing, run the **agent** on the PDV machine:
  ```bash
  cd agent
  npm i
  npm start
  ```
  Then the frontend/backend can call `http://127.0.0.1:9222/print`.
